# Лекция 5. Entity Framework Core (EF Core). ORM для C#

### Цель лекции

Познакомить студентов с ORM (Object-Relational Mapping) в C#, на примере Entity Framework Core, показать, как работать с базой данных через объекты C# без написания SQL-запросов вручную.

---

## **1. Что такое ORM**

* **ORM (Object-Relational Mapping)** — это технология, которая позволяет работать с базой данных через объекты языка программирования.
* Цель — избавиться от ручного написания SQL-запросов, облегчить поддержку кода.
* Пример: объект `Student` в C# соответствует таблице `Students` в базе данных.

---

## **2. Entity Framework Core (EF Core)**

* Современная ORM от Microsoft для .NET Core и .NET 5+.
* Поддерживает различные базы данных: SQL Server, SQLite, PostgreSQL, MySQL.
* Основные возможности:

  * Создание моделей (классов) и контекста базы данных
  * CRUD операции (Create, Read, Update, Delete)
  * LINQ-запросы к базе данных
  * Миграции (обновление структуры базы данных)

---

## **3. Основные компоненты EF Core**

1. **Entity (Сущность)**

   * Класс C#, который соответствует таблице в базе данных.

   ```csharp
   public class Student
   {
       public int Id { get; set; }
       public string Name { get; set; }
       public int Age { get; set; }
   }
   ```

2. **DbContext (Контекст базы данных)**

   * Основной класс для работы с EF Core.
   * Представляет сессию с базой данных.

   ```csharp
   using Microsoft.EntityFrameworkCore;

   public class SchoolContext : DbContext
   {
       public DbSet<Student> Students { get; set; }

       protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
       {
           optionsBuilder.UseSqlite("Data Source=school.db"); // можно использовать SQL Server, PostgreSQL и т.д.
       }
   }
   ```

3. **DbSet**

   * Представляет коллекцию объектов, соответствующих таблице.
   * Позволяет выполнять запросы, добавлять и удалять записи.

---

## **4. Основные операции**

1. **Добавление записи**

```csharp
using (var context = new SchoolContext())
{
    var student = new Student { Name = "Alice", Age = 20 };
    context.Students.Add(student);
    context.SaveChanges();
}
```

2. **Чтение данных**

```csharp
using (var context = new SchoolContext())
{
    var students = context.Students.ToList();
    foreach (var s in students)
    {
        Console.WriteLine($"{s.Id}: {s.Name}, {s.Age}");
    }
}
```

3. **Обновление данных**

```csharp
using (var context = new SchoolContext())
{
    var student = context.Students.First();
    student.Age = 21;
    context.SaveChanges();
}
```

4. **Удаление записи**

```csharp
using (var context = new SchoolContext())
{
    var student = context.Students.First();
    context.Students.Remove(student);
    context.SaveChanges();
}
```

---

## **5. LINQ-запросы с EF Core**

* Используем стандартные LINQ-операторы для фильтрации, сортировки и проекции данных:

```csharp
var adults = context.Students
                    .Where(s => s.Age >= 18)
                    .OrderBy(s => s.Name)
                    .ToList();
```

* Можно использовать методы `FirstOrDefault`, `SingleOrDefault`, `Any`, `Count`.

---

## **6. Миграции**

* EF Core позволяет обновлять структуру базы данных без ручного SQL.
* Команды:

  * `Add-Migration InitialCreate` — создать миграцию
  * `Update-Database` — применить миграцию к базе данных

---

## **7. Преимущества EF Core**

* Ускоряет разработку, меньше ручного кода.
* Позволяет работать с базой данных через привычные объекты C#.
* Поддерживает разные типы баз данных.
* Интеграция с ASP.NET Core и другими проектами .NET.

---

## **8. Недостатки EF Core**

* Возможна потеря производительности при сложных запросах.
* Не всегда можно контролировать SQL, который генерируется.
* Для сложных сценариев иногда требуется использовать чистый SQL (`FromSqlRaw`).

---

## **9. Пример полного кода EF Core**

```csharp
using System;
using System.Linq;
using Microsoft.EntityFrameworkCore;

public class Student
{
    public int Id { get; set; }
    public string Name { get; set; }
    public int Age { get; set; }
}

public class SchoolContext : DbContext
{
    public DbSet<Student> Students { get; set; }

    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
    {
        optionsBuilder.UseSqlite("Data Source=school.db");
    }
}

class Program
{
    static void Main()
    {
        using (var context = new SchoolContext())
        {
            context.Database.EnsureCreated();

            // Добавление
            context.Students.Add(new Student { Name = "Alice", Age = 20 });
            context.Students.Add(new Student { Name = "Bob", Age = 22 });
            context.SaveChanges();

            // Чтение
            var students = context.Students.ToList();
            foreach (var s in students)
                Console.WriteLine($"{s.Id}: {s.Name}, {s.Age}");

            // Обновление
            var firstStudent = context.Students.First();
            firstStudent.Age = 21;
            context.SaveChanges();

            // Удаление
            var lastStudent = context.Students.Last();
            context.Students.Remove(lastStudent);
            context.SaveChanges();
        }
    }
}
```

---

## **Контрольные вопросы**

1. Что такое ORM и зачем она нужна?
2. Чем отличается DbContext от DbSet?
3. Как добавить, прочитать, обновить и удалить запись через EF Core?
4. Как использовать LINQ с EF Core для фильтрации и сортировки данных?
5. Для чего нужны миграции и как их создавать?