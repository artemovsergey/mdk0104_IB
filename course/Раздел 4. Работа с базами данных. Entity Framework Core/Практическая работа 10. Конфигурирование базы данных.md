# Практическая работа 10. Конфигурирование базы данных

### Цель работы

Научиться настраивать и конфигурировать базу данных в проектах на C# с использованием Entity Framework Core. Освоить настройку подключения, параметров контекста, таблиц и отношений между сущностями.

---

## **Теоретическая часть**

1. **Что такое конфигурирование базы данных**

   * Конфигурирование позволяет определить, как классы C# отображаются на таблицы базы данных.
   * Настройка включает:

     * Подключение к БД
     * Имена таблиц и столбцов
     * Типы данных
     * Связи между таблицами (1:1, 1:М, М:М)
     * Ограничения (Primary Key, Foreign Key, Required, MaxLength)

2. **Настройка подключения к базе**

   * В `DbContext` через метод `OnConfiguring` или через Dependency Injection:

   ```csharp
   protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
   {
       optionsBuilder.UseSqlite("Data Source=school.db");
   }
   ```

   * Для SQL Server:

   ```csharp
   optionsBuilder.UseSqlServer("Server=.;Database=SchoolDB;Trusted_Connection=True;");
   ```

3. **Конфигурирование моделей**

   * Через **Data Annotations**:

     ```csharp
     public class Student
     {
         [Key]
         public int Id { get; set; }

         [Required]
         [MaxLength(50)]
         public string Name { get; set; }

         public int Age { get; set; }
     }
     ```
   * Через **Fluent API** в методе `OnModelCreating`:

     ```csharp
     protected override void OnModelCreating(ModelBuilder modelBuilder)
     {
         modelBuilder.Entity<Student>()
             .ToTable("Students")
             .HasKey(s => s.Id);

         modelBuilder.Entity<Student>()
             .Property(s => s.Name)
             .IsRequired()
             .HasMaxLength(50);
     }
     ```

4. **Настройка связей**

   * **Один ко многим (1:M):**

     ```csharp
     modelBuilder.Entity<Course>()
         .HasMany(c => c.Students)
         .WithOne(s => s.Course);
     ```
   * **Многие ко многим (M:M)**:

     * Используется промежуточная таблица (Enrollment)

5. **Миграции и создание базы**

   * `Add-Migration InitialCreate`
   * `Update-Database`

---

## **Ход работы**

1. Создать проект `DatabaseConfigDemo`.
2. Создать модели `Student`, `Course`, `Enrollment`.
3. Настроить конфигурацию:

   * Имена таблиц и столбцов
   * Ограничения (Required, MaxLength)
   * Связи между таблицами (1:M, M:M)
4. Создать контекст `SchoolContext` и настроить подключение к SQLite или SQL Server.
5. Создать миграцию и применить её.
6. Добавить несколько записей в таблицы и вывести их на экран.
7. Сделать скриншоты работы программы и поместить их в папку `images`.
8. Создать `readme.md` с описанием задания и примером кода.

---

## **Пример практического задания**

**Задание:**

1. Создать модели:

   * `Student` (Id, Name, Age)
   * `Course` (Id, Title)
   * `Enrollment` (StudentId, CourseId)
2. Настроить конфигурацию через Fluent API:

   * Ограничение длины Name и Title
   * Связь М:М через Enrollment
3. Создать контекст `SchoolContext` и подключение к SQLite.
4. Создать миграцию и обновить базу.
5. Добавить 2–3 студента и 2–3 курса с enrollments.
6. Вывести список студентов и их курсов.

**Пример кода конфигурации:**

```csharp
using Microsoft.EntityFrameworkCore;
using System.Collections.Generic;

public class Student
{
    public int Id { get; set; }
    public string Name { get; set; }
    public int Age { get; set; }
    public ICollection<Enrollment> Enrollments { get; set; }
}

public class Course
{
    public int Id { get; set; }
    public string Title { get; set; }
    public ICollection<Enrollment> Enrollments { get; set; }
}

public class Enrollment
{
    public int StudentId { get; set; }
    public Student Student { get; set; }

    public int CourseId { get; set; }
    public Course Course { get; set; }
}

public class SchoolContext : DbContext
{
    public DbSet<Student> Students { get; set; }
    public DbSet<Course> Courses { get; set; }
    public DbSet<Enrollment> Enrollments { get; set; }

    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
    {
        optionsBuilder.UseSqlite("Data Source=school.db");
    }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        modelBuilder.Entity<Student>()
            .Property(s => s.Name)
            .IsRequired()
            .HasMaxLength(50);

        modelBuilder.Entity<Course>()
            .Property(c => c.Title)
            .IsRequired()
            .HasMaxLength(100);

        modelBuilder.Entity<Enrollment>()
            .HasKey(e => new { e.StudentId, e.CourseId });

        modelBuilder.Entity<Enrollment>()
            .HasOne(e => e.Student)
            .WithMany(s => s.Enrollments)
            .HasForeignKey(e => e.StudentId);

        modelBuilder.Entity<Enrollment>()
            .HasOne(e => e.Course)
            .WithMany(c => c.Enrollments)
            .HasForeignKey(e => e.CourseId);
    }
}
```

---

## **Критерии оценки**

| Оценка | Критерий                                                                                                             |
| ------ | -------------------------------------------------------------------------------------------------------------------- |
| 2      | Частичная конфигурация моделей, ошибки при миграции или выводе данных                                                |
| 3      | Полная конфигурация моделей, миграция прошла успешно, вывод данных корректен                                         |
| 4      | Конфигурация моделей и связей выполнена через Fluent API, CRUD операции работают корректно                           |
| 5      | Отличная реализация конфигурации, все ограничения и связи настроены, аккуратный код, скриншоты и readme присутствуют |

---

## **Контрольные вопросы**

1. Для чего используется конфигурирование базы данных в EF Core?
2. Чем отличаются Data Annotations и Fluent API?
3. Как настроить связи между таблицами 1:M и M:M?
4. Как задать ограничения на длину строки и обязательность поля?
5. Как создать и применить миграцию для обновления базы данных?

---

## **Структура репозитория**

```
DatabaseConfigDemo/
│
├── DatabaseConfigDemo.sln
├── DatabaseConfigDemo/
│   ├── Program.cs
│   ├── SchoolContext.cs
│   └── Models/
│       ├── Student.cs
│       ├── Course.cs
│       └── Enrollment.cs
│
├── images/
│   ├── screenshot1.png
│   └── screenshot2.png
│
└── readme.md
```

### **Пример readme.md**

````markdown
# Практическая работа №10

**Тема:** Конфигурирование базы данных  

## Задание
1. Создать модели Student, Course, Enrollment
2. Настроить конфигурацию через Fluent API:
   - Ограничение длины Name и Title
   - Связь М:М через Enrollment
3. Создать контекст SchoolContext и подключение к SQLite
4. Создать миграцию и обновить базу
5. Добавить 2–3 студента и 2–3 курса с enrollments
6. Вывести список студентов и их курсов

## Пример кода
```csharp
// Пример конфигурации приведен выше
````

```